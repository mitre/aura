name: Control Table Data Ingestion

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  control-table-ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Pull down this repo
        uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P inspec -v 4.18.108
          npm install --only=dev
      - name: Ingest and process data
        run: |
          node ./control_table_data_ingest/ingest.js
          jq '.' ./src/assets/data/baselines.json > ./control_table_data_ingest/tmp_baselines.json && mv ./control_table_data_ingest/tmp_baselines.json ./src/assets/data/baselines.json
          jq '.' ./src/assets/data/mitre-saf-control-mapping.json > ./control_table_data_ingest/tmp_mitre-saf-control-mapping.json && mv ./control_table_data_ingest/tmp_mitre-saf-control-mapping.json ./src/assets/data/mitre-saf-control-mapping.json
      - name: Commit processed data
        run: |
          git config --global user.name 'MITRE SAF'
          git config --global user.email 'saf@groups.mitre.org'
          git add ./control_table_data_ingest/profiles
          git add ./src/assets/data/baselines.json
          git add ./src/assets/data/mitre-saf-control-mapping.json
          git commit -m 'Automated ingestion of profiles'
          git push "https://${GITHUB_ACTOR}:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git" HEAD:master
